---
title: "Analysis of fruitfly data"
format: 
  html:
    embed-resources: true
---

This program reads data on fruit fly longevity. Find more information in the [data dictionary][dd].

[dd]: https://github.com/pmean/data/blob/master/files/fruitfly.yaml

This code was written by Steve Simon on 2024-10-23 and is placed in the public domain.

## Load the tidyverse library

```{r setup}
#| message: false
#| warning: false
library(broom)
library(tidyverse)
```

For most of your programs, you should load the tidyverse library. The broom library converts your output to a nicely arranged dataframe. The messages and warnings are suppressed.

## List the variable names

```{r variable-list}
fn <- "https://jse.amstat.org/datasets/fruitfly.dat.txt"
vlist <- c(
  "id",
  "partners",
  "type",
  "longevity",
  "thorax",
  "sleep")
```

When a dataset does not have variables on the first line, you need to specify them in the code.

## Read the data and view a brief summary

```{r read}
fly <- read_fwf(
  "../data/fruitfly.txt",
  col_types="nnnnnn",
  fwf_widths(
    widths=c(2, 2, 2, 3, 5, 3),
    col_names=vlist))
glimpse(fly)
```

The fruitfly dataset has a fixed width format (fwf). You need to specify the columns that each variable uses.

## Create cage groups

```{r cage}
fly$cage <- 
  case_when(
    fly$partners==0 & fly$type==9 ~ "No females",
    fly$partners==1 & fly$type==0 ~ "One pregnant female",
    fly$partners==1 & fly$type==1 ~ "One virgin female",
    fly$partners==8 & fly$type==0 ~ "Eight pregnant females",
    fly$partners==8 & fly$type==1 ~ "Eight virgin females")
```

The five categories represent different combinations of partners and type.

## Calculate descriptive statistics

```{r longevity-means}
fly |>
  group_by(cage) |>
  summarize(
    longevity_mn=mean(longevity),
    longevity_sd=sd(longevity),
    n=n())
```

The mean lifespan is much lower for the eight virgin females group. The standard deviations are reasonably small and somewhat consistent across all groups.

## Draw boxplot

```{r longevity-boxplot}
#| fig.width: 6
#| fig.height: 2.5
fly |>
  ggplot(aes(cage, longevity)) +
    geom_boxplot() +
    ggtitle("Graph drawn by Steve Simon on 2024-10-23") +
    xlab("Cage residents") +
    ylab("Lifespan (days)") +
    coord_flip()
```

The boxplot also shows that the eight virgin females group has lower lifespans. The variation is roughly comparable across all groups. The distributions are reasonably symmetric with no outliers.

## Analysis of variance for longevity

```{r longevity-anova}
m1 <- aov(longevity ~ cage, data=fly)
tidy(m1)
```

## Linear model for longevity

```{r longevity-lm-1}
m2 <- lm(longevity ~ cage, data=fly)
anova(m2)
```

## Tukey post hoc comparisons

```{r longevity-tukey}
t1 <- TukeyHSD(m1, ordered=TRUE)
```

## Log transformation, 1

```{r log-longevity-anova-1}
fly |>
  mutate(log_longevity=log10(longevity)) -> log_fly
m3 <- aov(log_longevity ~ cage, data=log_fly)
tidy(m3)
```

## Log transformation, 2

```{r log-longevity-anova-2}
t3 <- TukeyHSD(m3, ordered=TRUE)
t3
```

## Log transformation, 3

```{r log-longevity-anova-3}
t3$cage |>
  data.frame() |>
  select(diff, lwr, upr) |> 
  mutate(
    diff=10^diff,
    lwr=10^lwr,
    upr=10^upr)
```

## Log transformation, 4

```{r log-longevity-anova-4}
t3$cage |>
  data.frame() |>
  select(diff, lwr, upr) |> 
  mutate(
    diff=10^(-diff),
    upr=10^(-lwr),
    lwr=10^(-upr))
```

## Save important files for later use

```{r save}
save(
  fly,
  log_fly,
  m1,
  m2,
  m3,
  t3,
  file="../data/firefly.RData")
```