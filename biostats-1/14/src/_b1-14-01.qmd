---
title: "14-01, Chi-squared test of independence"
format: 
  revealjs:
    slide-number: true
    embed-resources: true
editor: source
---

```{r}
#| label: 14-01-setup
#| message: false
#| warning: false
library(tidyverse)
```

```{r}
#| label: 14-01-titanic-yaml
#| output: asis
load("../../../general/chopper.RData")
partition_yaml("titanic.yaml") |>
	cat(sep="\n")
```

## Crosstabulation with row and column totals

-   Counts

```{r}
#| label: 14-01-crosstabulaton-1
load("../data/titanic.RData")
table1 <- xtabs(~sex+survived, data=ti)
table2 <- addmargins(table1)
table2
```

-   Cell percents

```{r}
#| label: 14-01-crosstabulaton-2
table3 <- table2/1313
table3

```

## Conditional probability

-   $P[A|B] = \frac{P[A \cap B]}{P[B]}$
    -   Note: $P[A|B] \ne P[B|A]$

## What does independence mean?

-   $P[A|B] = P[A]$
-   Equivalent definition of independence
    -   $P[A \cap B] = P[A] \times P[B]$

## Positive association

-   $P[A|B] > P[A]$
-   $P[A \cap B] > P[A] \times P[B]$
    -   Change direction for negative association

## Expected counts

```{}
             Good      Bad
            Outcome  Outcome     Total
Placebo        ?        ?       (a+b)/n
Treated        ?        ?       (c+d)/n
Total       (a+c)/n  (b+d)/n       1

where n=a+b+c+d

```

-   $E_{11}=n\times\frac{a+b}{n}\times\frac{a+c}{n}$
    -   $E_{12},\ E_{21},\ E_{22}$ are defined similarly

## Expected counts for Titanic data

```{}
        survived
sex            yes        no       Sum
  female                     0.3518660
  male                       0.6481340
  Sum    0.3427266 0.6572734 1.0000000
```

-   $E_{11}$ = 1313 $\times$ 0.3518660 $\times$ 0.3427266 = `r 1313*0.3518660*0.3427266`
-   $E_{12}$ = `r 1313*0.3518660*0.6572734`  
-   $E_{21}$ = `r 1313*0.6481340*0.3427266`
-   $E_{22}$ = `r 1313*0.6481340*0.6572734`  

##  Expected counts for Titanic data

-   Observed counts

```{r}
#| label: 14-01-observed
m1 <- chisq.test(table1, correct=FALSE)
m1$observed
```

-   Expected counts

```{r}
#| label: 14-01-expected
m1$expected
```

## Test statistic

-   $H_0:\ Independence$
-   $H_1:\ Dependence$
    -   $T=\Sigma_i \Sigma_j \frac{(O_{ij}-E_{ij})^2}{E_{ij}}$
    -   p-value = $P[T > \chi^2(df=1)]$
        -   Accept $H_0$ if T < $\chi^2(1-\alpha, df=1)$
        -   Accept $H_0$ if p-value > $\alpha$
    
## Example with Titanic data

-   $H_0:$ Mortality is independent of sex
-   $H_1:$ Mortality is related to sex
    
```{r}
#| label: 14-02-chi-squared
#| echo: true
m1 <- chisq.test(table1, correct=FALSE)
m1
```

:::notes
Since the test statistic is a lot larger than the degrees of freedom and since the p-value is small, reject the null hypothesis and conclude that there is a relationship between sex and survival.
:::

## Chi-squared test is an approximation

-   Reasonable if all expected counts > 5
-   Use Fisher's Exact test otherwise

## Fisher's exact test for the Titanic data

```{r}
#| label: 14-02-fisher
#| echo: true
m2 <- fisher.test(table1)
m2
```

:::notes
Although the expected counts are much larger than 5, here is the code for running Fisher's Exact test.
:::

## Calculations behind Fisher's Exact Test, 1

-   Fix column and row totals
    -   Let the interior cells vary

```{}
        survived
sex       yes   no  Sum
  female            462
  male              851
  Sum     450  863 1313
```

## Calculations behind Fisher's Exact Test, 2

-   Order the tables from most extreme

```{}
                    Most extreme

        survived                    survived            
sex       yes   no  Sum     sex       yes   no  Sum
  female  450       462       female    0       462
  male              851       male              851
  Sum     450  863 1313       Sum     450  863 1313


                 Second most extreme

        survived                    survived            
sex       yes   no  Sum     sex       yes   no  Sum
  female  449       462       female    1       462
  male              851       male              851
  Sum     450  863 1313       Sum     450  863 1313

```

## Calculations behind Fisher's Exact Test, 3

```{}
                  Third most extreme

        survived                    survived            
sex       yes   no  Sum     sex       yes   no  Sum
  female  448       462       female    2       462
  male              851       male              851
  Sum     450  863 1313       Sum     450  863 1313

                  Fourth most extreme

        survived                    survived            
sex       yes   no  Sum     sex       yes   no  Sum
  female  447       462       female    3       462
  male              851       male              851
  Sum     450  863 1313       Sum     450  863 1313
```


## Calculations behind Fisher's Exact Test, 4

```{r}
#| label: 14-01-urn-draw-1
p <- 0.3427266
a <- 1:50
b <- 51:1
y <- rep(c(a,b), 13)
x <- 1:1313
y <- sin(pi*x/75)
z <- sample(rep(c("F", "M"), c(462, 851)))
u <- ifelse(z=="F","pink2","lightblue")
data.frame(x, y, z, u) |>
	ggplot() +
	  aes(x, y, label=z) +
	  geom_text(color=u) +
	  theme_void() -> urn_plot
urn_plot
```

## Calculations behind Fisher's Exact Test, 4

```{r}
#| label: 14-01-urn-draw-2
urn_plot +
	geom_segment(
	 	x=450, xend=450, 
	  y=-1.1, yend=1.1)
```

## Calculations behind Fisher's Exact Test, 6

-   Hypergeometric distribution
    -   Similar to binomial, but trials not independent
    -   Relates to sampling without replacement/combinatorics

```{r}
#| label: 14-01-hypergeometric
p <- dhyper(0:450, 462, 863, 450)
data.frame(x=0:450, p=p) |>
	ggplot() +
	  aes(x, p) +
	  geom_col(color="black", fill="black") +
	  scale_x_continuous(breaks=(0:9)*50)
```

## Calculations behind Fisher's Exact Test, 5

```{r}
#| label: 14-01-urn-draw
n <- c(308, 142, 154, 709)
x1 <- runif(450, 0, p)
x2 <- runif(863, p, 1)
y <- runif(1313)
z <- rep(c("F", "M", "F", "M"), n)
u <- rep(c("pink2", "lightblue", "pink2", "lightblue"), n)
v <- rep(c(1, 5, 1), c(154, 450, 709))
data.frame(x, y, z) |>
	ggplot() +
	  aes(x, y, label=z) +
	  geom_text(size=v, color=u) + 
	  geom_segment(
	  	x=0.3427266, 
	  	xend=0.3427266, 
	  	y=0, 
	  	yend=1) +
	  theme_void()
```

        survived
sex       yes   no  Sum
  female  308  154  462
  male    142  709  851
  Sum     450  863 1313

## Criticism of Fisher's Exact Test
