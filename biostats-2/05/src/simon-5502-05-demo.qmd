---
title: "5502 module 04 demonstration program"
format: 
  html:
    embed-resources: true
editor: source
execute: 
  error: false
---

## File details

This program was written by Steve Simon on 2025-01-30 and is placed in the public domain. You can use this program any way you please.

There are two data files used in this program

-   exercise-programs, [SAS][ref03], [dictionary][ref04]
-   fev, [csv file][ref05], [dictionary][ref06]

[ref03]: https://raw.githubusercontent.com/pmean/data/main/files/exercise-programs.sas7bdat
[ref04]: https://github.com/pmean/data/blob/main/files/exercise-programs.yaml
[ref05]: https://github.com/pmean/data/blob/main/files/fev.txt
[ref06]: https://github.com/pmean/data/blob/main/files/fev.yaml

```{r}
#| label: setup
#| message: false
#| warning: false

library(broom)
library(glue)
library(tidyverse)
R.version.string
Sys.Date()
```

## Intermediate files

-   ex: Original data from exercise-programs.sas7bdat
-   ex_1: Create factors for female and prog
-   ex_2: Create indicator variables


## Read exercise data

```{r}
#| label: ex-read

library(haven)

ex <- read_sas(
  data_file="../data/exercise.sas7bdat")
glimpse(ex)
```

## Add factors

```{r}
#| label: ex-factors
lab1 <- c("Reading", "Jogging", "Swimming")
lab2 <- c("Male", "Female")

ex |> 
  mutate(prog=factor(prog, levels=c(3, 1, 2), labels=lab1)) |>
  mutate(gender=factor(female, levels=0:1, labels=lab2)) -> ex_1
```

#### Comment on the code

Notice that the levels for prog are specified in an alternative order. This is done to insure that the control group (reading) is the reference level in all statistical models.

I also used gender rather than female for the factor name. This is something I only noticed after working with this dataset for a while. Certain parts of the output would be labelled as femaleFemale or femaleMale and I thought it would look nicer as genderFemale and genderMale. Normally I try to avoid making too many changes to the names of variables. It makes it easier to refer back to the original data dictionary.

## Descriptive statistics

```{r}
#| label: ex-pct-1

ex_1 |>
	count(prog) |>
	mutate(total=sum(n)) |>
	mutate(pct=round(100*n/total)) |>
  mutate(pct=glue("{pct}% ({n}/{total})")) |>
  select(-n, -total)
```

#### Interpretation of the output

Exactly one third of the patients are in each of the three exercise programs.

```{r}
#| label: ex-pct-2

ex_1 |>
	count(i) |>
	mutate(total=sum(n)) |>
	mutate(pct=round(100*n/total, 2)) |>
  mutate(pct=glue("{pct}% ({n}/{total})")) |>
  select(-n, -total)
```

#### Interpretation of the output

This table doesn't really help so much and I should probably have deleted this program chunk.

```{r}
#| label: ex-mean-1

ex_1 |>
  summarize(
    hours_mean=mean(hours),
    hours_sd=sd(hours),
    hours_min=min(hours),
    hours_max=max(hours))
```

#### Interpretation of the output

The average patient exercised for 2 hours per week. There is a lot of variation, with at least one patient only exercising for ten minutes. 

```{r}
#| label: ex-pct-3

ex_1 |>
	count(gender) |>
	mutate(total=sum(n)) |>
	mutate(pct=round(100*n/total)) |>
  mutate(pct=glue("{pct}% ({n}/{total})")) |>
  select(-n, -total)
```

#### Interpretation of the output

There are equal numbers of men and women in the study.

#### Interpretation of the output

```{r}
#| label: ex-mean-2

ex_1 |>
  summarize(
    effort_mean=mean(effort),
    effort_sd=sd(effort),
    effort_min=min(effort),
    effort_max=max(effort))
```

#### Interpretation of the output

Effort is measured on a scale from 0 to 50. The average effort was 30, roughly in the middle of this range. There is only a moderate amount of variation, with no one really very close to the low extreme of 0 or the high extreme of 50.

```{r}
#| label: ex-mean-3

ex_1 |>
  summarize(
    loss_mean=mean(loss),
    loss_sd=sd(loss),
    loss_min=min(loss),
    loss_max=max(loss))
```

#### Interpretation of the output

The average weight loss is impressive, 30 pounds. There is a wide range with one person losing 54 pounds and another gaining 17 pounds.

## Interaction between prog and gender on loss

```{r}
#| label: ex-lines-1

ex_1 |>
  group_by(prog, gender) |>
  summarize(
    loss_mean=mean(loss)) |>
  ggplot() +
  aes(x=prog, y=loss_mean) +
  geom_line(aes(group=gender)) +
  geom_text(aes(label=gender)) +
  ggtitle("Graph drawn by Steve Simon on 2025-02-11") +
  xlab("Exercise program") +
  ylab("Average weight loss")
```

#### Comment on the code

There is a warning message associated with this program chunk. It does not affect the validity of the output. I explain some of the details behind this warning in a webpage to be published soon.

```{r}
#| label: ex-lines-2

ex_1 |>
  group_by(prog, gender) |>
  summarize(
    loss_mean=mean(loss)) |>
  ggplot() +
  aes(x=gender, y=loss_mean) +
  geom_line(aes(group=prog)) +
  geom_text(aes(label=prog)) +
  ggtitle("Graph drawn by Steve Simon on 2025-02-11") +
  xlab("Gender") +
  ylab("Average weight loss") -> plot_06
plot_06
```

#### Interpretation of the output

The two plots seem to emphasize different features of the data. The first plot emphasizes the superior average weight loss of women in the jogging group, men in the swimming group with identical average weight loss in the control (reading) group. The second plot seems to emphasize that jogging showed the best average weight loss and the control group showing the worst average weight loss. But if you look closely at either plot, you should notice both trends.

```{r}
#| label: ex-models

m4 <- lm(loss ~ 1, data=ex_1)
m5 <- lm(loss ~ gender+prog, data=ex_1)
m6 <- lm(loss ~ gender*prog, data=ex_1)

ex_1 |>
  mutate(GenderFemale=as.numeric(gender=="Female")) |>
  mutate(ProgSwimming=as.numeric(prog=="Swimming")) |>
  mutate(ProgJogging=as.numeric(prog=="Jogging")) |>
  mutate(GenderFemaleProgSwimming=GenderFemale*ProgSwimming) |>
  mutate(GenderFemaleProgJogging=GenderFemale*ProgJogging) -> ex_2

m7 <- lm(loss ~
	GenderFemale +
  ProgJogging +
	ProgSwimming +
	GenderFemaleProgSwimming +
	GenderFemaleProgJogging, 
	data=ex_2)
```

#### Comment on the code

Placing the term "gender+prog" on the right hand side of the tilde fits a model with an indicator for gender and two indicators for prog. In contrast, the term "gender*prog" fits a model with these indicators plus interactions associated with the products of the one gender indicator and the two prog indicators.

```{r}
#| label: parameters
tidy(m6) |>
  mutate(
    p.value =
      case_when(
        p.value >= 0.001 ~ glue("p = {round(p.value, 3)}"),
        p.value <  0.001 ~ "p < 0.001")) -> table_09
table_09
```

```{r}
coef(m6)
coef(m7)
```




```{r}
#| label: ex-models

m4 <- lm(loss ~ 1, data=ex_1)
m5 <- lm(loss ~ gender+prog, data=ex_1)
m6 <- lm(loss ~ gender*prog, data=ex_1)

ex_1 |>
  mutate(GenderFemale=as.numeric(gender=="Female")) |>
  mutate(ProgSwimming=as.numeric(prog=="Swimming")) |>
  mutate(ProgJogging=as.numeric(prog=="Jogging")) |>
  mutate(GenderFemaleProgSwimming=GenderFemale*ProgSwimming) |>
  mutate(GenderFemaleProgJogging=GenderFemale*ProgJogging) -> ex_2
```

#### Comment on the code

Placing the term "gender+prog" on the right hand side of the tilde fits a model with an indicator for gender and two indicators for prog. In contrast, the term "gender*prog" fits a model with these indicators plus interactions associated with the products of the one gender indicator and the two prog indicators.

```{r}
#| label: parameters
tidy(m6) |>
  mutate(
    p.value =
      case_when(
        p.value >= 0.001 ~ glue("p = {round(p.value, 3)}"),
        p.value <  0.001 ~ "p < 0.001")) -> table_09
table_09
```

```{r}
coef(m4)
```

## Interaction between prog and hours on loss

## Interaction between hours and effort on loss

## fev

```{r}
#| label: fev-read

vars <- c(
  "age", 
  "fev",
  "ht", 
  "sex",
  "smoke")

pulmonary <- read_csv(
  file="../data/fev.csv",
  col_names=vars,
  col_types="nnncc")
glimpse(pulmonary)
```

## Save everything

```{r}
#| label: save
save(
  ex,
  ex_1,
  ex_2,
  file="../data/module05.RData")
```