---
title: "5502 module 05 demonstration program"
format: 
  html:
    embed-resources: true
editor: source
execute: 
  error: false
---

## File details

This program was written by Steve Simon on 2026-02-16 and is placed in the public domain. You can use this program any way you please.

There are three data files used in this program

-   exercise-programs, [SAS file][ref-exercise-sas], [dictionary][ref-exercise-yaml]
-   fev, [csv file][ref-fev-csv], [dictionary][ref-fev-yaml]
-   tracking, [txt file][ref-tracking-txt], [dictionary][ref-tracking-yaml]

[ref-exercise-sas]: https://raw.githubusercontent.com/pmean/data/main/files/exercise-programs.sas7bdat
[ref-exericse-yaml]: https://github.com/pmean/data/blob/main/files/exercise-programs.yaml
[ref-fev-csv]: https://github.com/pmean/data/blob/main/files/fev.txt
[ref-fev-yaml]: https://github.com/pmean/data/blob/main/files/fev.yaml
[ref-tracking-txt]: https://github.com/pmean/data/blob/main/files/tracking.txt
[ref-tracking-yaml]: https://github.com/pmean/data/blob/main/files/tracking.yaml

```{r}
#| label: setup
#| message: false
#| warning: false

library(broom)
library(glue)
library(tidyverse)

R.version.string
Sys.Date()
```

## Intermediate files, tracking

-   tracking0: oringinal data from tracking.txt
-   tracking1: rename sex to gender
-   tracking2: computed child variable from age

## Intermediate files, exercise

-   exercise: Original data from exercise-programs.sas7bdat
-   exercise_1: Create factors for female (gender) and prog
-   exercise_2: Create indicator variables

# --- Part 1, Interactions in multi-factor analysis of variance

## Read tracking data

```{r}
#| label: read-tracking

tracking0 <- read_tsv(
  file="../data/tracking.txt",
  col_types="cncnnnn",
  col_names=TRUE)
names(tracking0) <- tolower(names(tracking0))
tracking0 |>
  rename(gender=sex) -> tracking1

glimpse(tracking1)
```

#### Comments on the code

When I was writing up some of the interpretations for this program, I decided I did not like the juxtaposition of "child" and "sex". I was worried that some filter would trap my code and flag it for an investigation of pedophilia. Without going into any of the technical distinctions between the two terms, I decided to change "sex" to "gender".

The [rename function][ref-rename] changes the names in a data frame or tibble. The new name goes to the left of the equal sign and the old name goes to the right.

[ref-rename]: https://dplyr.tidyverse.org/reference/rename.html


::: notes
The tracking dataset looks at a task where volunteer subjects of both genders and a wide range of ages performed a test of motor skills where they tried to track a moving target on a rotating disk. A larger value indicates better motor skills. We will use age to divide the sample into children and adults.
:::

## Create Child variable

```{r}
#| label: create-child

tracking1 |>
  mutate(child = case_when(
    age <= 18 ~ "Yes",
    age > 18 ~ "No")) |>
  mutate(child=factor(child, levels=c("Yes", "No"))) -> tracking2
```

#### Comment on the code

After looking at some of the tables, I decided that I wanted to use child="Yes" and gender="F" as the reference categories. The [factor function][ref-factor] allows you to override the default in R to use the first category that appears in alphabetical order as the reference category. I don't need to do anything with gender, because the default is already what I want.

[ref-factor]: https://stat.ethz.ch/R-manual/R-devel/library/base/html/factor.html

## Descriptive statistics for gender

```{r}
#| label: gender-counts

tracking2 |>
  count(gender) |>
  mutate(total=sum(n)) |>
  mutate(pct=round(100*n/total)) |>
  mutate(pct=glue("{pct}% ({n}/{total})")) |>
  select(-n, -total) -> gender_table

gender_table
```

#### Interpretatipon of the output

Males comprise 62% of the sample

## Descriptive statistics for child

```{r}
#| label: child-counts

tracking2 |>
  count(child) |>
  mutate(total=sum(n)) |>
  mutate(pct=round(100*n/total)) |>
  mutate(pct=glue("{pct}% ({n}/{total})")) |>
  select(-n, -total) -> child_table

child_table
```

#### Interpretation of the output

Children (18 and younger) comprise 56% of the sample.

## Descriptive statistics for trial4

```{r}
#| label: trial4-mean

tracking2 |>
  summarize(
    trial4_mean=mean(trial4),
    trial4_sd=sd(trial4),
    trial4_min=min(trial4),
    trial4_max=max(trial4)) -> trial4_table

trial4_table
```

#### Interpretation of the output

Let's focus initially on the fourth trial. This is possibly a better indication of moter skills than the previous three trials (practice makes perfect), but that is a bit speculative on my part. The tracking task lasted for 15 seconds, so the average time is quite low. There is a wide range of variation, with one subject tracking for more than 11 seconds out of 15.

## Group means

```{r}
#| label: trial4-interaction-table

tracking2 |>
  group_by(child, gender) |>
  summarize(mean_trial4=mean(trial4), .groups="drop") -> trial4_interaction_table

trial4_interaction_table
```

## Interaction plot, 1

```{r}
#| label: trial4-plot-1

range_trial4 <- range(tracking2$trial4)

trial4_interaction_table |>
  ggplot() +
  aes(
    x=child,
    y=mean_trial4,
    group=gender,
    label=gender) +
  geom_line() +
  geom_text() +
  scale_y_continuous(limits=range_trial4) +
  labs(
    x="Child?",
    y="Tracking time (seconds)",
    caption="Simon, 2026-02-05") -> trial4_plot1

trial4_plot1
```

#### Comments on the code

The [aes function][ref-aes] tells you more than just what goes on the X and Y axes. Assigning a categorical variable to another graphical feature like `color` will end up stratifying your geom by that category. In this case, it produces boxplots with tracking time on the x axis, with separate boxplots on the y axis for children and adults and further stratified by gender (male and female). This produces four boxplots: female children, male children, female adults, and male adults.

[ref-aes]: https://ggplot2.tidyverse.org/reference/aes.html

#### Interpretation of the output

The times are fairly similar for male and female children. Both tend to produce smaller times than adults. Among adults, there appears to be a difference between males and females. This is possible evidence of an interaction.


## Interaction plot, 2

```{r}
#| label: trial4-plot-2

trial4_interaction_table |>
  ggplot() +
  aes(
    x=gender,
    y=mean_trial4,
    group=child,
    label=child) +
  geom_line() +
  geom_text() +
  scale_y_continuous(limits=range_trial4) +
  labs(
    x="gender",
    y="Tracking time (seconds)",
    caption="Simon, 2026-02-10") -> trial4_plot2

trial4_plot2
```

## Analysis with and without an interaction

```{r}
#| label: lm-trial4-model

lm_trial4_full_model <- lm(trial4~gender+child+gender:child, data=tracking2)
lm_trial4_reduced_model <- lm(trial4~gender+child, data=tracking2)

anova(
    lm_trial4_reduced_model,
    lm_trial4_full_model) |>
  tidy() |>
  mutate(
    p.value =
      case_when(
        p.value >= 0.001 ~ glue("p = {round(p.value, 3)}"),
        p.value <  0.001 ~ "p < 0.001")) -> anova_trial4_table

anova_trial4_table
```

```{r}
#| label: interaction-coefficients

tidy(lm_trial4_full_model) |>
  mutate(
    p.value =
      case_when(
        p.value >= 0.001 ~ glue("p = {round(p.value, 3)}"),
        p.value <  0.001 ~ "p < 0.001")) -> estimates_trial4_table
  
estimates_trial4_table
```

There are two data files used in this program


#### Comment on the code

I need to save some of the objects created by R for use in a different program. It has gotten a bit unwieldy, so I am using a list, sv, to store everything in one place. You do not need to do this for your program, but it doesn't hurt either.

## --- Part 2, Interactions in analysis of covariance

## Read exercise data

```{r}
#| label: exercise-read

library(haven)

exercise0 <- read_sas(
  data_file="../data/exercise-programs.sas7bdat")
glimpse(exercise0) 
```

#### Comment on the code

The [read_sas function][ref-read-sas], part of the [haven library][ref-haven], will read the binary proprietary files of SAS. These binary files of SAS use the extension sas7bdat. The haven library also has functions to read the binary proprietary files of SPSS and Stata.

[ref-haven]: https://cran.r-project.org/web/packages/haven/refman/haven.html
[ref-read-sas]: https://cran.r-project.org/web/packages/haven/refman/haven.html

## Add factors

```{r}
#| label: exercise-factors
lab1 <- c("Reading", "Jogging", "Swimming")
lab2 <- c("Male", "Female")

exercise0 |> 
  mutate(prog=factor(prog, levels=c(3, 1, 2), labels=lab1)) |>
  mutate(gender=factor(female, levels=0:1, labels=lab2)) -> exercise1
```

#### Comment on the code

Notice that the levels for prog are specified in an alternative order. This is done to insure that the control group (reading) is the reference level in all statistical models.

I also used gender rather than female for the factor name. This is something I only noticed after working with this dataset for a while. Certain parts of the output would be labelled as femaleFemale or femaleMale and I thought it would look nicer as genderFemale and genderMale. Normally I try to avoid making too many changes to the names of variables. It makes it easier to refer back to the original data dictionary.

## Descriptive statistics, prog

```{r}
#| label: count_prog_table

exercise1 |>
	count(prog) |>
	mutate(total=sum(n)) |>
	mutate(pct=round(100*n/total)) |>
  mutate(pct=glue("{pct}% ({n}/{total})")) |>
  select(-n, -total) -> count_prog_table

count_prog_table
```

#### Interpretation of the output

Exactly one third of the patients are in each of the three exercise programs.

## Descriptive statistics, hours


```{r}
#| label: mean-hours-table

exercise1 |>
  summarize(
    hours_mean=mean(hours),
    hours_sd=sd(hours),
    hours_min=min(hours),
    hours_max=max(hours)) -> mean_hours_table

mean_hours_table
```

#### Interpretation of the output

The average patient exercised for 2 hours per week. There is a lot of variation, with at least one patient only exercising for ten minutes. 

## Descriptive statistics, loss

```{r}
#| label: mean-loss-table

exercise1 |>
  summarize(
    loss_mean=mean(loss),
    loss_sd=sd(loss),
    loss_min=min(loss),
    loss_max=max(loss)) -> mean_loss_table

mean_loss_table
```

#### Interpretation of the output

The average weight loss is moderate, 10 pounds, though that is still impressive and hard to achieve. There is a wide range with one person losing 54 pounds and another gaining 17 pounds.

## Interaction between prog and hours

```{r}
#| label: exercise-interaction-plot
#| message: false

exercise1 |>
  ggplot() +
  aes(x=hours, y=loss, color=prog) +
  geom_point() +
  geom_smooth(method="lm") +
  labs(
    x="Average amount of exercise (hours/week)",
    y="Weight loss (pounds)",
    caption="Steve Simon, 2026-02-16, CC0") -> interaction_exercise_plot

interaction_exercise_plot
```

## Linear models

```{r}
#| label: exercise-models

exercise1 |>
  mutate(hours_mean=mean(hours)) |>
  mutate(hours_centered=hours-hours_mean) -> exercise2

lm_loss_reduced_model <- lm(
  loss ~ prog+hours_centered, 
  data=exercise2)
lm_loss_full_model <- lm(
  loss ~ prog+hours_centered+prog:hours_centered, 
  data=exercise2)
```

#### Comment on the code

When you are examininginteractions involving continuous variable, you must make sure that the zero value for the continuous variable is inside the range of the data. The best way to do this is to center the continuous variable. Centering is subtracting the mean. The centered value has a mean of zero and the intercept represents the estimated average at the mean of the independent variable.

## Comparison of models with and without an interaction.

```{r}
#| label: loss-anova

anova(lm_loss_reduced_model, lm_loss_full_model) |>
  tidy() |>
  mutate(
    p.value =
      case_when(
        p.value >= 0.001 ~ glue("p = {round(p.value, 3)}"),
        p.value <  0.001 ~ "p < 0.001")) -> anova_loss_interaction_table

anova_loss_interaction_table
```

#### Interpretation of the output

The model without an interaction has unexplained variation of 43 thousand. The model with an interaction has substantially smaller unexplained variation, 38 thousand. The difference is statistically significant because the F-ratio (62.9) is much larger than 1 and the p-value is very small (less than 0.001). There is sufficient evidence to conclude that a model with an interaction predicts better predictions than a model without an interaction.

## Parameters with an interaction

```{r}
#| label: estimates-loss-interaction-table
tidy(lm_loss_full_model) |>
  mutate(
    p.value =
      case_when(
        p.value >= 0.001 ~ glue("p = {round(p.value, 3)}"),
        p.value <  0.001 ~ "p < 0.001")) -> estimates_loss_interaction_table


estimates_loss_interaction_table
```

#### Interpretation of the output

The reference category is reading and the intercept is computed at the mean of 2 hours of exercise. So the intercept represents the estimated average change in weight for a person with 2 hours of exercise in the reading group. Two hours of reading "exercise" will lead to a 4 pound weight gain on average. The indicator variable for jogging (progJogging) indicates that if you switch from two hours of reading to two hours of jogging, you will be better off by 12 pounds. Since -4 plus 12 equals 8, you could also say that the estimated average weight loss for two hours of jogging is a bit more than 8 pounds. It looks even better for swimming. Someone who spends two hours with swimming exercise is 29.6 pounds better off on average than somone who spends two hours with reading exercise. Adding -4 to 30 gets you 26. This tells you that the average weight loss for someone spending two hours swimming is about 26 pounds. 

The slope for hours centered is -3, meaning that for each additional hour of reading exercise, you gain an extra 3 pounds. So three hours of reading exercises leads to a -4 plus -3 equals -7 or a 7 pound weight gain on average. Four hours of reading exercises leads to a 10 pound weight gain on average. Dropping down to only one hour of reading exercises leads to a 1 pound weight gain on average, almost no change in weight at all.

The interaction between the jogging program and hours centered is 10. This tells you that the slope for a one hour change in the jogging program is 10 pounds per hour better than the slope for reading. Adding -3 and 10 equals 7. So spending three hours instead of two hours of jogging and you get 7 more pounds of weight loss or 15 pounds total. Spending one hour instead of two hours jogging and you get seven pounds less weight loss on average or one pound weight loss total. This is almost no change at all and quite similar to the value seen for the patients spending one hour reading.

The interaction between the swimming program and hours centered is also 10.The slope for a one hour change in the swimming program is ten pounds per hour better than the slope for reading. So like jogging an extra hour spent jogging adds an extra 7 pounds to the weight loss. Three hours spent swimming leads to an average weight loss of 26+7=33 pounds. One hour spent swimming leads to an average weight loss of 26-7=19 pounds.


# --- Part 3, Interactions in multiple linear regression

## fev

```{r}
#| label: fev-read

vars <- c(
  "age", 
  "fev",
  "ht", 
  "sex",
  "smoke")

pulmonary <- read_csv(
  file="../data/fev.csv",
  col_names=vars,
  col_types="nnncc")
glimpse(pulmonary)
```

```{r}
#| message: false

pulmonary |>
  mutate(ht_groups=ntile(ht, n=6)) |>
  ggplot() + 
  aes(x=age, y=fev) +
  geom_point() +
  geom_smooth(method="lm") +
  facet_wrap(vars(ht_groups))
```

```{r}
#| message: false

pulmonary |>
  mutate(age_groups=ntile(age, n=6)) |>
  ggplot() + 
  aes(x=ht, y=fev) +
  geom_point() +
  geom_smooth(method="lm") +
  facet_wrap(vars(age_groups))
```
```{r}

pulmonary |> 
  mutate(age_mean=mean(age)) |>
  mutate(ht_mean=mean(ht)) |>
  mutate(age_centered=age-age_mean) |>
  mutate(ht_centered=ht-ht_mean) -> pulmonary1

m1 <- lm(fev~age_centered+ht_centered, data=pulmonary1)
m2 <- lm(fev~age_centered+ht_centered+age_centered:ht_centered, data=pulmonary1)
anova(m1, m2)
```

```{r}
tidy(m2)
```

```{r}

glance(m1) |> select(r.squared)
glance(m2) |> select(r.squared)
```

## Save everything

```{r}
#| label: save

save.image(file="../data/module05.RData")
```

#### Comment on the code

There are so many things that I needed to save, that I decided to use the [save.image function][ref-sav-image], which saves every object that this program created.

[ref-save-image]: https://stat.ethz.ch/R-manual/R-devel/library/base/html/save.html