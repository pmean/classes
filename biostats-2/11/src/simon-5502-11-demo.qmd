---
title: "simon-5502-11-demo"
format: 
  html:
    embed-resources: true
editor: source
execute: 
  error: false
---

## File details

This program was written by Steve Simon on 2025-02-23 and is placed in the public domain. You can use this program any way you please.

-   Data used in this program
    -   physical-activity
        -   [tab delimited file][ref-pa]
        -   [dictionary][ref-pa-dd]
    -   oa
        -   [tab delimited file][ref-oa]
        -   [dictionary][ref-oa-dd]
    
-   Tibbles created by this program
    -   oa: Original data from arthritis-treatments
    -   oa_1: Subset with only VAS values
    -   oa_2: Restructure to long format
    -   pa: Original data from physical-activity-sav
    -   pa_1: Compute change score
-   Models created by this program
    -   m1: Mixed model with school as a random effect

[ref-oa]: https://github.com/pmean/data/blob/main/files/oa.txt
[ref-oa-dd]: https://github.com/pmean/data/blob/main/files/oa.yaml
[ref-pa]: https://github.com/pmean/data/blob/main/files/physical-activity.sav
[ref-pa-dd]: https://github.com/pmean/data/blob/main/files/physical-activity.yaml


```{r}
#| message: false
#| warning: false
#| label: setup

library(broom)
library(foreign)
library(lme4)
library(nlme)
library(tidyverse)

R.version.string
Sys.Date()
```

## Read oa

```{r}
#| label: read-oa

oa <- read_table(
  file="../data/arthritis-treatments.txt",
  col_names=TRUE,
  col_types="nnnnnnn")

glimpse(oa)
```

## Create subset for VAS

```{r}
#| label: subset

oa |>
  select(
    Subject,
    NoROM,
    TENSROM,
    SWDROM) |>
  rename(
    no=NoROM,
    tens=TENSROM,
    swd=SWDROM) -> oa_1
```

## Restructure into long format

```{r}
#| label: long

oa_1 |>
  pivot_longer(
    cols=no:swd,
    names_to="treatment",
    values_to="rom") -> oa_2

glimpse(oa_2)
```


## Descriptive statistics

```{r}
#| label: descriptives-oa

oa_2 |>
  group_by(treatment) |>
  summarize(
    vas_mean=mean(rom),
    vas_sd=sd(rom))
```

## Plot by subject

```{r}
#| label: plot-1

oa_2 |>
  ggplot() +
  aes(
    x = treatment, 
    y = rom, 
    group = Subject) +
  geom_line()
```

## Mixed model for oa

```{r}
#| label: mixed-oa

m1 <- lmer(
  rom ~ treatment + (1 | Subject),
  data=oa_2)

summary(m1)
```

## Variance components

```{r}
v1 <- VarCorr(m1)
v1
```


## Read physical-activity

```{r}
#| label: read-pa

pa <- read.spss(
  file="../data/physical-activity.sav",
  to.data.frame=TRUE)

glimpse(pa)
```

## Descriptive statistics

```{r}
#| label: descriptives-pa

pa |>
  summarize(
    mean_pre=mean(WC_PRE, na.rm=TRUE),
    mean_post=sd(WC_POST, na.rm=TRUE))
```

## Compute change score

```{r}
#| label: change-score

pa |>
  mutate(change_score=WC_POST - WC_PRE) -> pa_1
```

## Draw boxplot by school

```{r}
#| label: box-1

pa_1 |>
  filter(!is.na(change_score)) |>
  ggplot() +
  aes(
    x=factor(School), 
    y=change_score) +
  geom_boxplot() +
  coord_flip() +
  xlab("School") +
  ylab("Change score") +
  ggtitle("Graph drawn by Steve Simon on 2025-04-06")
```

## Draw boxplot by group

```{r}
#| label: box-2
#| fig.height: 1.5
#| fig.width: 6

pa_1 |>
  filter(!is.na(change_score)) |>
  ggplot() +
  aes(
    x=Group_allocation, 
    y=change_score) +
  geom_boxplot() +
  coord_flip() +
  xlab("Group") +
  ylab("Change score") +
  ggtitle("Graph drawn by Steve Simon on 2025-04-06")
```

## Fit mixed model

```{r}
#| label: mixed

m2 <- lmer(
  change_score ~ Group_allocation + (1 | School),
  data=pa_1)

summary(m2)
```

## Variance components

```{r}
v2 <- VarCorr(m2)
v2
```

## Save everything

```{r}
#| label: save

save.image(file="../data/module11.RData")
```
